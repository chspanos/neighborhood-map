var model={map:null,markers:[],selectedMarker:null,placeInfoWindow:null,bounds:null,mapData:{name:"Lafayette, CA, USA",location:{lat:37.8857582,lng:-122.1180201}},places:[{name:"Lafayette Reservoir",address:"3849 Mt Diablo Blvd, Lafayette, CA",location:{lat:37.884793,lng:-122.145527},types:["establishment","park","point_of_interest"],placeId:"ChIJd9qeu-1ihYAR447rYG0Eo8M",foursquareId:"49e3cfdff964a520dd621fe3"},{name:"Lafayette Hillside Memorial",altName:"The Crosses of Lafayette",address:"Deer Hill Rd, Lafayette, CA",location:{lat:37.895186,lng:-122.123683},types:["establishment","park","point_of_interest","premise"],placeId:"ChIJRxvxSlFihYAR7K0dDXrNYTw",foursquareId:"4d3b29d7325ff04dac782345"},{name:"Lafayette Library and Learning Center",address:"3491 Mt Diablo Blvd, Lafayette, CA",location:{lat:37.89185459999999,lng:-122.1158424},types:["establishment","library","point_of_interest"],placeId:"ChIJBYwuMVtihYARffszT-0XSBg",foursquareId:"535087d4498e9ee4197d639a"},{name:"Lafayette Elementary School",address:"950 Moraga Rd, Lafayette, CA",location:{lat:37.8888137,lng:-122.1177424},types:["establishment","point_of_interest","school"],placeId:"ChIJtaIzNFtihYAR_FWVrpZ3P7Q",foursquareId:"4aabd0f4f964a520345a20e3"},{name:"Artisan Bistro",address:"1005 Brown Ave, Lafayette, CA",location:{lat:37.8939938,lng:-122.1106254},types:["bar","establishment","food","point_of_interest","restaurant"],placeId:"ChIJM6KKP0ZihYAR2Qm_0TPpFrw",foursquareId:"4a1f0c12f964a520fc7b1fe3"},{name:"Orchard Nursery and Florist",address:"4010 Mt Diablo Blvd, Lafayette, CA",location:{lat:37.89033939999999,lng:-122.1521502},types:["establishment","florist","food","point_of_interest","store"],placeId:"ChIJT33wd-BihYARKiJaprWzfkY",foursquareId:"4a81e76bf964a520ebf71fe3"},{name:"Acalanes High School",address:"1200 Pleasant Hill Rd, Lafayette, CA",location:{lat:37.9029113,lng:-122.0975344},types:["establishment","point_of_interest","school"],placeId:"ChIJS6QiMDJihYARswhGXvI5h-E",foursquareId:"4b46b108f964a520dd2626e3"},{name:"Lafayette Park Hotel",address:"3287 Mt Diablo Blvd, Lafayette, CA",location:{lat:37.8960141,lng:-122.101025},types:["establishment","lodging","point_of_interest"],placeId:"ChIJJY3FhjlihYARapU2reVVa1M",foursquareId:"4ada326bf964a520d41f21e3"},{name:"Uncle Yu's",address:"999 Oak Hill Rd, Lafayette, CA",location:{lat:37.8923289,lng:-122.1207499},types:["establishment","food","point_of_interest","restaurant"],placeId:"ChIJ3UQEflBihYARtJ_sy15TMfI",foursquareId:"4b11ed12f964a520128723e3"},{name:"Lafayette Community Garden",address:"3932 Mt Diablo Blvd, Lafayette, CA",location:{lat:37.8892375,lng:-122.14153},types:["establishment","park","point_of_interest"],placeId:"ChIJP_FAx-RihYARLCNN_G67_fg",foursquareId:"5658d31e498e840922293eae"}],options:["all","park","school","food","library","lodging"]},Place=function(a){this.name=ko.observable(a.name),this.altName=ko.observable(a.altName),this.address=ko.observable(a.address),this.location=ko.observable(a.location),this.types=ko.observableArray(a.types),this.placeId=ko.observable(a.placeId),this.foursquareId=ko.observable(a.foursquareId),this.fourSqLink=ko.observable(""),this.fourSqTitle=ko.observable(""),this.fourSqMsg=ko.observable(""),this.fourSqCategories=ko.observable(""),this.wikiLink=ko.observable(""),this.wikiTitle=ko.observable(""),this.wikiMsg=ko.observable(""),this.placesImg=ko.observable(""),this.isDisplayed=ko.observable(!0),this.isSelected=ko.observable(!1),this.imgSrc=ko.computed(function(){if(""!==this.placesImg())return this.placesImg();var a="https://maps.googleapis.com/maps/api/streetview?key=AIzaSyAz3kOqii58xK05S23w4e-NfhwY02oq4Uw&size=200x150&location=";return a+this.location().lat+","+this.location().lng},this)};Place.prototype.loadPlaceDetails=function(a){var b=this,c=new google.maps.places.PlacesService(a);c.getDetails({placeId:b.placeId()},function(a,c){if(c===google.maps.places.PlacesServiceStatus.OK){if(a.photos){var d=a.photos[0].getUrl({maxWidth:200,maxHeight:150});""!==d&&b.placesImg(d)}}else window.alert("Google Places search failed due to "+c)})};var mapView={displayMap:function(a){var b=null;return b=new google.maps.Map(document.getElementById("map"),{center:{lat:a.lat,lng:a.lng},zoom:13}),null===b&&window.alert("ERROR: Google Maps API was unable to display map"),b},mapError:function(){window.alert("ERROR: Google Maps API was unable to generate map")},initBounds:function(){return new google.maps.LatLngBounds},initInfoWindow:function(){return new google.maps.InfoWindow},createMapMarker:function(a,b,c,d,e){var f=new google.maps.Marker({map:a,position:c,title:d,animation:google.maps.Animation.DROP,id:e});return f.addListener("click",function(){viewModel.updateSelectedPlace(this.id)}),b.extend(f.position),a.fitBounds(b),f},createInfoWindow:function(a,b){if(b.marker!=a){b.marker=a;var c=viewModel.setInnerHTML();b.setContent(c),b.open(map,a),b.addListener("closeclick",function(){null!==this.marker&&this.marker.setAnimation(null),this.marker=null})}},highlightMarker:function(a){a.setAnimation(google.maps.Animation.BOUNCE)},unhighlightMarker:function(a){a.setAnimation(null)},updateMarker:function(a,b){a.setVisible(b)}},CLIENT_ID="IDA2YR42QMPJ0O04TMIIGNX42BMNK4Z3UGQTVY2DFF5I2MSV",CLIENT_SECRET="SZ3FOYMEK0530G2JDCSHAUJSRPMMYKFFKIFITLFFZ1P01CWI";Place.prototype.loadFSData=function(){var a=this,b=20160108,c="https://api.foursquare.com/v2/venues",d=c+"/"+a.foursquareId();$.ajax({url:d,data:{client_id:CLIENT_ID,client_secret:CLIENT_SECRET,v:b,async:!0},dataType:"json"}).done(function(b){for(var c=b.response.venue.canonicalUrl,d="",e=b.response.venue.categories,f=0;f<e.length;f++)d+=e[f].name,f<e.length-1&&(d+=", ");a.fourSqLink(c),a.fourSqTitle(a.name()),a.fourSqCategories(d),a.fourSqMsg("")}).fail(function(b){a.fourSqLink(""),a.fourSqTitle(""),a.fourSqMsg("Foursquare search failed for this location")})},Place.prototype.loadWikiData=function(){var a=this,b=a.name(),c="https://en.wikipedia.org/w/api.php";$.ajax({url:c,data:{action:"opensearch",search:b,format:"json",async:!0},dataType:"jsonp",jsonp:"callback"}).done(function(b){var c=b[1],d=b[3];if(c.length>0){var e=c[0],f=d[0];a.wikiLink(f),a.wikiTitle(e),a.wikiMsg("")}else a.wikiLink(""),a.wikiTitle(""),a.wikiMsg("No matching Wikipedia entries found")}).fail(function(b){a.wikiLink(""),a.wikiTitle(""),a.wikiMsg("Wikipedia search failed for this location")})};var ViewModel=function(){var a=this;this.menuVisible=ko.observable(!1),this.toggleMenu=function(){this.menuVisible(!this.menuVisible())},this.availableFilters=ko.observableArray([]),model.options.forEach(function(b){a.availableFilters.push(b)}),this.selectedFilter=ko.observable(this.availableFilters()[0]),this.placeList=ko.observableArray([]),model.places.forEach(function(b){a.placeList.push(new Place(b))}),this.filteredList=ko.computed(function(){return ko.utils.arrayFilter(this.placeList(),function(b){var c=a.selectedFilter();return"all"===c?(b.isDisplayed(!0),!0):b.types().indexOf(c)>=0?(b.isDisplayed(!0),!0):(b.isDisplayed(!1),!1)})},this),this.selectedPlace=ko.observable(null),this.init=function(){model.map=mapView.displayMap(model.mapData.location),model.bounds=mapView.initBounds(),model.placeInfoWindow=mapView.initInfoWindow(),this.loadData(),this.createMarkers()},this.loadData=function(){a.placeList().forEach(function(a){a.loadFSData(),a.loadWikiData(),a.loadPlaceDetails(model.map)})},this.createMarkers=function(){for(var a=0;a<this.placeList().length;a++){var b,c=this.placeList()[a].name(),d=this.placeList()[a].location();b=mapView.createMapMarker(model.map,model.bounds,d,c,a),model.markers.push(b)}},this.selectPlace=function(b){b!==a.selectedPlace()&&(a.toggleSelect(b),a.selectedPlace(b));var c=a.placeList.indexOf(b);a.activateMarker(model.markers[c])},this.updateSelectedPlace=function(b){var c=a.placeList()[b];a.selectPlace(c)},this.toggleSelect=function(b){null!==a.selectedPlace()&&a.selectedPlace().isSelected(!1),b.isSelected(!0)},this.activateMarker=function(a){null!==model.selectedMarker&&mapView.unhighlightMarker(model.selectedMarker),model.selectedMarker=a,mapView.highlightMarker(a),mapView.createInfoWindow(a,model.placeInfoWindow)},this.selectedFilter.subscribe(function(b){for(var c=0;c<a.placeList().length;c++)mapView.updateMarker(model.markers[c],a.placeList()[c].isDisplayed());a.selectPlace(a.filteredList()[0])},this,"change"),this.setInnerHTML=function(){var b=a.selectedPlace(),c="";return c+='<h3 class="info-header">'+b.name()+"</h3>",c+="<p>"+b.address()+"</p>",c+="<p>"+b.fourSqCategories()+"</p>",c+='<img src="'+b.imgSrc()+'" alt="place image">',c+='<p class="fa-foursquare">',c+='<a href="'+b.fourSqLink()+'" target="blank">'+b.fourSqTitle()+"</a>",c+="<span>"+b.fourSqMsg()+"</span>",c+='<p class="fa-wikipedia-w">',c+='<a href="'+b.wikiLink()+'" target="blank">'+b.wikiTitle()+"</a>",c+="<span>"+b.wikiMsg()+"</span>",c+='<p class="attributions">Images courtesy of Google Places and  StreetView APIs. Wikipedia link courtesy of Wikipedia API. Categories and link courtesy of Foursquare API.</p>'}},viewModel=new ViewModel;ko.applyBindings(viewModel);